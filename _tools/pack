#!/bin/bash
#
# Creates a release package from the current sandbox.
# @param	1	Version of this release
#

# check args
	if [ -z "$1" ]
	then
		echo "usage: ./pack <release_version>"
		exit
	fi

## vars

pack_upload_scp_url=$UCSC_ID:public_html/pub/projects/ff/
upload_scp_url=$UCSC_ID:public_html/pub/tmp/
upload_web_url=http://people.ucsc.edu/~skurapat/pub/tmp/


	# version of this release
	pack_ver=$1
	
	# files that use gettext
	pot_in=( ../libs/ff.lib ../docs/*.man )
	
	# files that need to be translated; these are automatically packaged
	doc_in=( ../docs/*.html )
	
	# other files to be packaged
	pack_in=( ../libs ../docs ../scripts/ ../ff ../fl )
	
	pack_dir=../_pack/ff-$pack_ver
	pack_dir_docs=$pack_dir/docs

## setup

	# remove previously generated files
	rm -rvf $pack_dir ${pack_dir}.* ../i18n/*

	# create pack dir
	mkdir -p $pack_dir
	
	# transfer unprocessable input files into dir
	cp -vr "${pack_in[@]}" $pack_dir
	../ff -e '[ "$fn" == "CVS" ] || [ "${fn:0:1}" == . ] && rm -rfv "$f"' -ar $pack_dir # remove CVS dirs and hidden files

## gettext translation

	echo "pack: create *.pot files; say NO to raw output"
	../ff -e '( ../fl -f ../scripts/fl.xgettext $f ) > $w/../i18n/$fn.pot' "${pot_in[@]}"

	echo "pack: translate *.pot files"
	../ff -f ff.auto_i18n ../i18n/*

	# format PO files
	../ff -e 'for x in ${f%.pot}* ; do export PO_FMT_DATA=$x ; ../fl -f ./fl.po_fmt $f > $$ ; mv -v $$ $x ; done ; rm -f $$' ../i18n/*.pot
	
	# copy result files
	cp -vr ../i18n $pack_dir

## regular translation

	# prepare input files and their URLs
		i=0
		while [ $i -lt ${#doc_in[@]} ]
		do
			# vars
				# base name of the input file
				doc_nom[$i]=${doc_in[$i]##*/}
				
				# web url to temp .html files
				doc_url[$i]=${upload_web_url}${doc_nom[$i]}
			
			# put English copy into packd_dir
				cp ${doc_in[$i]} $pack_dir_docs/${doc_nom[$i]}
				
			# make temp file for translation processing
				cp -v ${doc_in[$i]} ${doc_nom[$i]}
			
			let i=i+1
		done
		
	# translate temp files
		echo "pack: upload readme files"
		scp "${doc_nom[@]}" $upload_scp_url
		
		echo "pack: translate readme files"
		../ff -f ../scripts/ff.translate_url "${doc_url[@]}"

	# move translated files to pack dir
		for x in "${doc_nom[@]}"
		do
			# make id-anchor URLs local
			../ff -e "sed 's/\(href=\"\)[^>]*#/\1#/g' \$f > $pack_dir_docs/\${fn//.html/}.html ; rm -f \$f" ${x}*
		done

		for f in $pack_dir_docs/*html
		do 
			sed 's!http://babelfish.altavista.com/babelfish/trurl_pagecontent?lp=.._..&url=http%3a%2f%2fpeople.ucsc.edu%2f%7eskurapat%2fpub%2ftmp%2f!!g' < "$f" > /tmp/$$ && mv -vf /tmp/$$ "$f"
		done

## package creation

	read -p "Now, make any last minute changes before creating packs..."

	pushd $pack_dir/..
		
		tar -jcf ${pack_dir}.tar.bz2 ${pack_dir##*/}
		tar -zcf ${pack_dir}.tar.gz ${pack_dir##*/}
		zip -r ${pack_dir}.zip ${pack_dir##*/}
		
	popd
	

