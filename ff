#!/bin/bash
# For each File (ff)
# This file is distributed under the same license as the "ff" package.

## global paths

	_ff_path=$0			# path to this program
	[ -L "$_ff_path" ] && _ff_path=$( find "$_ff_path" -printf "%l" )	# dereference if path is symlink
	
	_ff_name=${_ff_path#*/}		# basename of this program
	_ff_base=${_ff_path%/*}		# dirname of this program
	_ff_base_lib=${_ff_base}/lib	# libraries
	_ff_base_doc=${_ff_base}/doc	# documentation
	_ff_base_i18n=${_ff_base}/i18n	# i18n resources
	
## libraries

	source ${_ff_base_lib}/ff_common

## global variables

	# temporary files
	_ff_tmp_dirList=${_ff_tmpMask}.dirList

	# command line options
	_ff_cmdOpts=alr
	_ff_cmdOpts_optFlg_handleHidden=a
	_ff_cmdOpts_optFlg_followLinks=l
	_ff_cmdOpts_optFlg_recursive=r

## functions

	# handles parsing of command-line options
	_cmdOpts_handleOption()
	{
		case "$1" in
			$_ff_cmdOpts_optFlg_handleHidden)
				_ff_cmdOpts_optEn_handleHidden=1
				return 1
			;;
			$_ff_cmdOpts_optFlg_followLinks)
				_ff_cmdOpts_optEn_followLinks=1
				return 1
			;;
			$_ff_cmdOpts_optFlg_recursive)
				_ff_cmdOpts_optEn_recursive=1
				return 1
			;;
			*) # handle base options
				_ff_handleBaseOption "$1" "$2"
				return $?
			;;
		esac
	}

	_ff_main()
	{
		# scripting variables
		local w=$PWD d f fn
		
		begin	# user function

		# check method of operation: recursive or non-recursive
		if [ ${_ff_cmdOpts_optEn_recursive:-0} -eq 1 ] # recursive operation
		then
			(
				shopt -s nullglob
			
				local basedir filelist
	
				# handle each target
				for basedir in "${_cmdOpts_argList[@]}"
				do
					if [ -d "$basedir" ] # handle directories only
					then
						# handle all subdirectories, starting with the deepest sub-directories first
						ls -R${_ff_cmdOpts_optEn_followLinks:+L}${_ff_cmdOpts_optEn_handleHidden:+A} "$basedir" | sed -n 's/:$//p' | sort -r | 
						while read d
						do
							# set scripting variables
							d=${d%/}
							
							# for all files in subdir
							for f in "$d"/* $( [ ! -z "$_ff_cmdOpts_optEn_handleHidden" ] && echo "$d/.*" )
							do
								# set scripting variables
								fn=${f##*/}
	
								# user function
								main
							done
						done
					fi
					
				done
			)

		else # non-recursive operation

			# handle each target
			for f in "${_cmdOpts_argList[@]}"
			do
				# set scripting variables
				
					f=${f%/}
					fn=${f##*/}
					
					# determine directory path
					if [ "$fn" == "$f" ]
					then
						d=.
						f=./$f
					else
						d=${f%/*}
					fi
				
				# handle user's script
				main	# user function
			
			done
		fi

		end	# user function
	}

## main script logic

	# dummy user functions
	begin() { :; }
	end() { :; }
	main() { :; }
	
	# begin script
	_ff_baseLogic "${@}"

